<!DOCTYPE html>
<meta charset="utf-8" />
<title>desktop</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="/style.css" id="theme" />

<script type="module">
  import trap from "../42/fabric/type/error/trap.js"
  trap()
</script>

<script type="module">
  import os from "../42/os.js"
  import ui from "../42/ui.js"
  import io from "../42/io.js"

  // import disk from "../42/core/disk.js"
  // await disk.reinstall()

  /* --- video blob test --- */
  const videoBlobTest = 0
  if (videoBlobTest) {
    try {
      await navigator.serviceWorker?.register("/42.sw.js", { type: "module" })
      await navigator.serviceWorker.ready
    } catch {}

    const fs = await import("../42/core/fs.js").then((m) => m.default)
    const http = await import("../42/core/http.js").then((m) => m.default)

    try {
      await fs.delete("/example.mp4")
    } catch {}

    await http
      .source("/tests/fixtures/formats/video/example.mp4")
      .pipeTo(fs.sink("/example.mp4"))

    io.launchFile("/example.mp4")
  }
  /* ----- */

  os.desktop = await ui({
    tag: "body.box-fit.box-v._debug",
    content: [
      {
        scope: "desktop",
        tag: "main#desktop.desktop",
        on: [
          {
            "selector": 'ui-icon[aria-description="folder"]',
            "dblclick || Enter || Space": "{{io.launchFolder(target.path)}}",
          },
          {
            "selector": 'ui-icon[aria-description="file"]',
            "dblclick || Enter || Space": "{{io.launchFile(target.path)}}",
          },
        ],
        content: [
          {
            tag: "ui-folder.box-fit.scroll-auto",
            // path: "/tests/fixtures/formats/**/*",
            // glob: true,
          },
        ],
      },
      videoBlobTest && {
        tag: "video",
        src: "/example.mp4",
        controle: true,
      },
      {
        scope: "taskbar",
        tag: "footer#taskbar.d-flex.outset.pa-xs",
        content: [
          {
            tag: "button",
            content: "Start",
            picto: "puzzle",
            menu: [{ label: "start", click: "{{start(e, target)}}" }],
          },
          {
            if: "{{/errors.length > 0}}",
            tag: ".solid.error.ml-auto",
            content: "{{/errors.length}} error(s)",
          },
        ],
        actions: {
          start(e, target) {
            console.log("start", e, target)
          },
        },
      },
    ],

    state: {
      errors: [],
    },
  })

  // io.launchFolder("/tests/fixtures/formats/audio/")
  // io.launchFile("/tests/fixtures/formats/example.html")
  // io.launchFile("/tests/fixtures/formats/video/example.mp4")
  io.launchFile("/tests/fixtures/formats/example.json")
  // io.launchFile("/tests/fixtures/formats/image/example.jpg")
</script>
