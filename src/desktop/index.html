<!DOCTYPE html>
<meta charset="utf-8" />
<title>desktop</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="/style.css" id="theme" />

<script type="module">
  import trap from "../42/fabric/type/error/trap.js"
  trap()
</script>

<style>
  textarea {
    caret: steelblue;
  }

  div > pre {
    display: block;
  }
</style>

<script type="_module">
  let resolve
  const p = new Promise((r) => {
    console.log(111)
    resolve = r
  })

  setTimeout(() => {
    resolve("coucou")
  }, 100)

  console.log(await p)
</script>

<script type="_module">
  import ui from "../42/ui.js"
  import http from "../42/core/http.js"
  import stream from "../42/core/stream.js"
  // import idle from "../42/fabric/type/promise/idle.js"
  import repaint from "../42/fabric/type/promise/repaint.js"
  import paintThrottle from "../42/fabric/type/function/paintThrottle.js"
  import defer from "../42/fabric/type/promise/defer.js"
  import { round } from "../42/fabric/type/number/precision.js"

  ui({
    tag: ".box-h.box-fit",
    content: [
      { tag: "input" }, //
      // { tag: "textarea.font-mono" },
      { tag: "div.font-mono.w-full.scroll" },
    ],
  })

  const input = document.querySelector("input")
  const textarea = document.querySelector(".font-mono")

  function sinkToElement(el) {
    const _line = document.createElement("div")
    return new WritableStream(
      {
        async write(chunk) {
          const line = _line.cloneNode(true)
          line.textContent = chunk
          el.append(line)

          // console.log(el.scrollHeight / 2, el.clientHeight + el.scrollTop)

          if (el.scrollHeight / 2 > el.clientHeight + el.scrollTop) {
            await new Promise((resolve) => {
              const onscroll = () => {
                el.removeEventListener("scroll", onscroll)
                resolve()
              }

              el.addEventListener("scroll", onscroll)
            })
          }
        },

        close() {
          // update()
        },
      },
      { highWaterMark: 1 }
    )
  }

  http
    .stream("../tests/fixtures/stream/html_standard.html.gz")
    .headers((headers, rs) => {
      const len = Number(headers.get("content-length"))
      rs.pipeThrough(stream.ts.cut(1500))
        .pipeThrough(
          stream.ts.percent(len, (percent) => {
            input.value = round(percent)
          })
        )
        .pipeThrough(stream.ts.decompress())
        .pipeThrough(stream.ts.text())
        .pipeThrough(stream.ts.split())
        .pipeTo(sinkToElement(textarea, len))
    })
</script>

<script type="module">
  import ui from "../42/ui.js"
  import http from "../42/core/http.js"
  import stream from "../42/core/stream.js"
  import idle from "../42/fabric/type/promise/idle.js"
  import repaint from "../42/fabric/type/promise/repaint.js"
  import paintThrottle from "../42/fabric/type/function/paintThrottle.js"
  import defer from "../42/fabric/type/promise/defer.js"
  import { round } from "../42/fabric/type/number/precision.js"

  ui({
    tag: ".box-h.box-fit",
    content: [
      { tag: "input" }, //
      { tag: "textarea.font-mono" },
    ],
  })

  const input = document.querySelector("input")
  const textarea = document.querySelector("textarea")

  function sinkToElement(el) {
    let buffer = ""
    function update() {
      el.value = buffer
      return idle().then(() => {
        pending = false
      })
    }

    let pending = false

    return new WritableStream(
      {
        async write(chunk) {
          buffer += chunk

          if (pending) return
          if (el.scrollHeight / 2 > el.clientHeight + el.scrollTop) return

          pending = true
          await update()
        },

        close() {
          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              update()
            })
          })
        },
      },
      { highWaterMark: 1 }
    )
  }

  http
    .stream("../tests/fixtures/stream/html_standard.html.gz")
    .headers((headers, rs) => {
      const len = Number(headers.get("content-length"))
      rs
        // .pipeThrough(stream.ts.cut(1500))
        .pipeThrough(
          stream.ts.percent(len, (percent) => {
            input.value = round(percent)
          })
        )
        .pipeThrough(stream.ts.decompress())
        .pipeThrough(stream.ts.cut(1500))
        .pipeThrough(stream.ts.text())
        // .pipeThrough(stream.ts.split())
        .pipeTo(sinkToElement(textarea, len))
    })
</script>

<script type="_module">
  import "../42/os.js"
  import explorer from "../42/ui/components/explorer.js"
  explorer("/tests/fixtures/website/", { _glob: true })
  // import puppet from "../42/core/dev/puppet.js"
  // await puppet('ui-icon[path$="index.html"]').dblclick()
</script>

<script type="_module">
  import "../42/os.js"
  import ui from "../42/ui.js"
  import explorer from "../42/ui/components/explorer.js"
  import open from "../42/os/cmd/open.cmd.js"

  await ui({
    tag: "body.box-fit.box-h._debug",
    content: [
      {
        tag: "main#desktop.desktop",
        on: [
          {
            "selector": 'ui-icon[aria-description="folder"]',
            "dblclick || Enter || Space": "{{openFolder(target.path)}}",
          },
          {
            "selector": 'ui-icon[aria-description="file"]',
            "dblclick || Enter || Space": "{{openFile(target.path)}}",
          },
        ],
        content: [
          {
            tag: "ui-folder.box-fit.scroll-auto",
          },
        ],
      },
      {
        scope: "taskbar",
        tag: "footer#taskbar.outset.pa-xs",
        content: {
          tag: "button",
          content: "Start",
          picto: "puzzle",
          menu: [{ label: "start" }],
        },
      },
    ],

    actions: {
      openFolder(path) {
        explorer(path)
      },
      openFile(path) {
        open(path)
      },
      taskbar: {
        start(e, target) {
          console.log("start", e, target)
        },
      },
    },
  })

  explorer("/42/fabric/")

  // import puppet from "../42/core/dev/puppet.js"
  // await puppet.when("uidialogopen")
  // await puppet('ui-icon[path="/42/fabric/constants/"]').dblclick()

  // await puppet('ui-icon[path="/42/"]').dblclick().when("uidialogopen")
  // await puppet('ui-icon[path="/42/os.js"]').dblclick()

  // await puppet('ui-icon[path="/files.json"]').dblclick()

  // if (globalThis.top === globalThis) open("/desktop/index.html")
  // else await puppet('ui-icon[path="/style.css"]').dblclick()
</script>
