<!DOCTYPE html>
<meta charset="utf-8" />
<title>desktop</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="/style.css" id="theme" />

<script type="module">
  import trap from "../42/fabric/type/error/trap.js"
  trap()
</script>

<script type="module">
  import system from "../42/os.js"
  import ui from "../42/ui.js"
  import engage from "../42/os/engage.js"

  import fs from "../42/core/fs.js"

  if (!(await fs.access("/test.html"))) {
    await fs.write(
      "/test.html",
      `
<link rel="stylesheet" href="/test.css">coucou
<script>
console.log(111, location)
console.log(112, window.top.document.body.append("evil"))
</${"script"}>
`
    )
    await fs.write("/test.css", "body{background:tan}")
  }

  await navigator.serviceWorker?.register("/42.sw.js", { type: "module" })
  await navigator.serviceWorker.ready

  system.desktop = await ui(
    {
      tag: "body.box-fit.box-h._debug",
      content: [
        {
          scope: "desktop",
          tag: "main#desktop.desktop",
          on: [
            {
              "selector": 'ui-icon[aria-description="folder"]',
              "dblclick || Enter || Space": "{{openFolder(target.path)}}",
            },
            {
              "selector": 'ui-icon[aria-description="file"]',
              "dblclick || Enter || Space": "{{openFile(target.path)}}",
            },
          ],
          content: [{ tag: "ui-folder.box-fit.scroll-auto" }],
          actions: {
            openFolder: engage.openFolder,
            openFile: engage.openFile,
          },
        },

        // {
        //   tag: "iframe",
        //   sandbox: "allow-scripts allow-same-origin",
        //   src: "/test.html",
        // },

        {
          tag: "iframe",
          sandbox: "allow-scripts allow-same-origin",
          src: "/vhost.html",
        },

        // {
        //   tag: "iframe",
        //   // sandbox: "allow-scripts _allow-same-origin",
        //   sandbox: "allow-scripts",
        //   src: "/test.html",
        //   _srcdoc: `
        //   <link rel="stylesheet" href="/test.css">
        //   <script type="module">

        //   console.log(888)

        //   // await navigator.serviceWorker?.register("/42.sw.js", { type: "module" })

        //   // fetch('/test.html').then(res => {
        //   //   console.log(res)
        //   // })

        //   </${"script"}>
        //   yo
        //   `,
        // },

        {
          scope: "taskbar",
          tag: "footer#taskbar.d-flex.outset.pa-xs",
          content: [
            {
              tag: "button",
              content: "Start",
              picto: "puzzle",
              menu: [{ label: "start", click: "{{start(e, target)}}" }],
            },
            {
              if: "{{/errors.length > 0}}",
              tag: ".solid.error.ml-auto",
              content: "{{/errors.length}} error(s)",
            },
          ],
          actions: {
            start(e, target) {
              console.log("start", e, target)
            },
          },
        },
      ],

      state: {
        errors: [],
      },
    },
    { trusted: true }
  )

  // const iframe = document.querySelector("iframe")

  // console.log(iframe)

  // engage.openFolder("/users/")

  // import puppet from "../42/core/dev/puppet.js"
  // await puppet('ui-icon[path="/style.css"]').dblclick()
</script>
