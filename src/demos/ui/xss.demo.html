<!DOCTYPE html>
<meta charset="utf-8" />
<title>popup</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="/style.css" id="theme" />

<script type="module">
  import trap from "../../42/fabric/type/error/trap.js"
  trap()
</script>

<script type="module">
  // Fail because Content-Security-Policy in Resource.js
  // doesn't allow scripts without sha256 hash

  import ui from "../../42/ui.js"
  import ipc from "../../42/core/ipc.js"
  import when from "../../42/fabric/type/promise/when.js"

  const secret = "hello secret"
  localStorage.setItem("SECRET", secret)

  const app = ui([
    {
      tag: "ui-sandbox",
      permissions: "app",
      script: `
ipc.to.parent.emit('xss', "hello secret")
`,
    },
  ])

  const res = await Promise.race([
    when(app.el, "error"), //
    ipc.once("xss"),
  ])

  console.log(res)
</script>

<script type="_module">
    // Fail because Content-Security-Policy in Resource.js
    // doesn't allow scripts without sha256 hash

    import ui from "../../42/ui.js"

    localStorage.setItem("SECRET", "hello secret")

    ui([
      {
        // dummy dialog to force top ipc response
        tag: "ui-dialog",
        label: "dummy dialog",
      },
      {
        // try to use "app" permission only to get top level secret
        tag: "ui-sandbox",
        permissions: "app",
        script: `\
  console.log("sandbox script")
  const script = document.createElement("script")
  // script.type = "importmap"
  script.textContent = "console.log('untrusted script')"
  document.body.append(script)
      `,
      },
    ])
</script>

<script type="_module">
    // Fail because Content-Security-Policy in Resource.js
    // doesn't allow scripts without sha256 hash

    import ui from "../../42/ui.js"

    localStorage.setItem("SECRET", "hello secret")

    ui([
      {
        // dummy dialog to force top ipc response
        tag: "ui-dialog",
        label: "dummy dialog",
      },
      {
        // try to use "app" permission only to get top level secret
        tag: "ui-sandbox",
        permissions: "app",

        // override xrealm.js using importmap
        // using malware-xrealm.js here but xrealm.js could be bundled
        // to make it work as a base64 string
        html: `\
  <script type="importmap">
    { "imports": { "/42/core/ipc/xrealm.js": "../../tests/fixtures/security/malware-xrealm.js" } }
  </${"script"}>
  <script type="module">
    import dialog from "../../42/ui/components/dialog.js"
    import xrealm from "../../42/core/ipc/xrealm.js"
    dialog(
      {
        label: "malware",
        content: {
          tag: "ui-sandbox",
          permissions: "trusted",
          script: "console.log(localStorage.getItem('SECRET'))"
        }
      },
      { trusted: true }
    )
  </${"script"}>
      `,
      },
    ])
</script>

<script type="_module">
  // Fail because xrealm.inTop is not writable

  import ui from "../../42/ui.js"

  localStorage.setItem("SECRET", "hello secret")

  ui([
    {
      // dummy dialog to force top ipc response
      tag: "ui-dialog",
      label: "dummy dialog",
    },
    {
      // try to use "app" permission only to get top level secret
      tag: "ui-sandbox",
      permissions: "app",
      script: `
  import dialog from "../../42/ui/components/dialog.js"
  import xrealm from "../../42/core/ipc/xrealm.js"
  // xrealm.inTop = true
  Object.defineProperty(xrealm, "inTop", {get: ()=> true})
  dialog(
    {
      label: "malware",
      content: {
        tag: "ui-sandbox",
        permissions: "trusted",
        script: "console.log(localStorage.getItem('SECRET'))"
      }
    },
    { trusted: true }
  )
  `,
    },
  ])
</script>

<script type="_module">
  // Fail because ctx.trusted is not transfered from to top realm

  import ui from "../../42/ui.js"

  localStorage.setItem("SECRET", "hello secret")

  ui([
    {
      // dummy dialog to force top ipc response
      tag: "ui-dialog",
      label: "dummy dialog",
    },
    {
      // try to use "app" permission only to get top level secret
      tag: "ui-sandbox",
      permissions: "app",
      script: `
  import dialog from "../../42/ui/components/dialog.js"
  import xrealm from "../../42/core/ipc/xrealm.js"
  dialog(
    {
      label: "malware",
      content: {
        tag: "ui-sandbox",
        permissions: "trusted",
        script: "console.log(localStorage.getItem('SECRET'))"
      }
    },
    { trusted: true }
  )
  `,
    },
  ])
</script>
