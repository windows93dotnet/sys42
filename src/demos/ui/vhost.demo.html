<!DOCTYPE html>
<meta charset="utf-8" />
<title>vhost</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="/style.css" id="theme" />

<script type="module">
  import trap from "../../42/fabric/type/error/trap.js"
  trap()
</script>

<script type="module">
  import "../../42/ui/components/dialog.js"
  import ui from "../../42/ui.js"
  import ipc from "../../42/core/ipc.js"
  import fs from "../../42/core/fs.js"

  localStorage.setItem("secret", "hello secret")

  const html = `\
  <link rel="stylesheet" href="/test.css">
  I'm a sandboxed iframe.<br />
  The HTML and CSS are served from browser storage.
  <hr />
  <script type="module">
  if (localStorage.getItem('secret') === "hello secret") {
    document.body.append('Sandboxing failed')
  } else {
    try {
      window.top.document.body.append("XSS")
      document.body.append('Sandboxing failed')
    } catch {
      document.body.append('Sandboxing succeed')
    }
  }
  </${"script"}>`
  const css = "body { background: tan; font-family: sans-serif; }"

  await Promise.all([
    fs.write("/test.html", html), //
    fs.write("/test.css", css),
  ])

  const useIpc = 0

  const vhostOrigin = "http://localhost:3000"

  if (useIpc) {
    ipc.from(vhostOrigin).on("42_VHOST_REQ", async (url) => fs.read(url))
  } else {
    globalThis.addEventListener("message", async ({ data, source, origin }) => {
      if (origin !== vhostOrigin) return
      if (data.type === "42_VHOST_REQ") {
        source.postMessage(
          {
            ...data,
            type: "42_VHOST_RES",
            file: await fs.read(data.pathname),
          },
          vhostOrigin
        )
      }
    })
  }

  await ui(
    {
      tag: "body.box-center",
      content: [
        {
          tag: "h2.ma-b-0",
          content: "Service Worker virtual host experiment",
        },
        {
          tag: "div",
          content: [
            "This is a proof of concept to try to overcome the fact that Service Worker don't work in sandboxed iframes.",
            "\n\n",
            {
              tag: "a",
              href: "https://github.com/w3c/ServiceWorker/issues/1390",
              content: "https://github.com/w3c/ServiceWorker/issues/1390",
            },
            "\n\n",
            "\n\n",
            "⚠️ this can make the browser crash for unknown reasons (maybe a bug in ipc.js)",
          ],
        },
        {
          tag: "iframe.ma-t.inset",
          style: { width: "512px", height: "256px" },
          sandbox: "allow-scripts allow-same-origin",
          src: useIpc
            ? `${vhostOrigin}/42-vhost.html?path=/test.html`
            : `${vhostOrigin}/42-vhost2.html?path=/test.html`,
        },
      ],
    },
    { trusted: true }
  )
</script>
